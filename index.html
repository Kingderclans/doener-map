<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Döner Map Berlin + Firestore robust</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
html,body{height:100%;margin:0;}
#map{height:100vh;width:100%;}
.popup-content{font-family:sans-serif;font-size:14px;min-width:220px;}
.popup-content label{display:block;margin-top:6px;font-weight:600;}
.popup-content input{width:100%;padding:4px;margin-top:4px;box-sizing:border-box;}
.popup-content button{margin-top:8px;padding:6px 8px;cursor:pointer;}
#errorOverlay{position:fixed;left:8px;right:8px;top:8px;z-index:99999;background:#fff7f7;border:1px solid #d33;color:#600;padding:10px;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.15);}
</style>
</head>
<body>
<div id="errorOverlay" role="alert"></div>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
(function(){
  function esc(s){ return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function showError(msg){ const el=document.getElementById('errorOverlay'); el.style.display='block'; el.innerText='Fehler: '+msg; console.error(msg); }

  try{
    const map = L.map('map').setView([52.52,13.405],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap-Mitwirkende'}).addTo(map);

    const firebaseConfig = {
      apiKey: "AIzaSyCBWlHG4LLLPM-_dWV2eqw0Vwh1BvlcL-A",
      authDomain: "activespiess-433b5.firebaseapp.com",
      projectId: "activespiess-433b5",
      storageBucket: "activespiess-433b5.firebasestorage.app",
      messagingSenderId: "927921088097",
      appId: "1:927921088097:web:05e6691473e3ded984ac20",
      measurementId: "G-SXHQE7RB6M"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const markers = [];

    db.collection("doenerlaeden").get().then((querySnapshot)=>{
      if(querySnapshot.empty){
        showError('Keine Dönerläden in Firestore gefunden.');
        return;
      }
      querySnapshot.forEach((doc)=>{
        const data = doc.data();
        // robust coords prüfen
        let coords = data.coords;
        if(!Array.isArray(coords) || coords.length !== 2){
          coords = [52.52,13.405]; // Standard Berlin
          console.warn('coords fehlt oder falsch formatiert, Standard verwendet für', data.name);
        }

        const idx = markers.length;
        const marker = L.marker(coords).addTo(map);

        function popupHtml(){
          return '<div class="popup-content">'+
                 '<h3>'+esc(data.name)+'</h3>'+
                 '<p><b>Spieß:</b> '+esc(data.spiess)+'</p>'+
                 '<p><b>Öffnungszeiten:</b> '+esc(data.oeffnungszeiten)+'</p>'+
                 '<p><b>Adresse:</b> '+esc(data.addr||'')+'</p>'+
                 '<p><b>Telefon:</b> '+esc(data.tel||'')+'</p>'+
                 '<hr>'+
                 '<label for="spiess-'+idx+'">Spieß</label><input id="spiess-'+idx+'" value="'+esc(data.spiess)+'"/>'+
                 '<label for="oeff-'+idx+'">Öffnungszeiten</label><input id="oeff-'+idx+'" value="'+esc(data.oeffnungszeiten)+'"/>'+
                 '<label for="addr-'+idx+'">Adresse</label><input id="addr-'+idx+'" value="'+esc(data.addr||'')+'"/>'+
                 '<label for="tel-'+idx+'">Telefon</label><input id="tel-'+idx+'" value="'+esc(data.tel||'')+'"/>'+
                 '<button id="save-'+idx+'">Speichern</button>'+
                 '</div>';
        }

        marker.bindPopup(popupHtml());
        marker.on('popupopen', ()=>{
          setTimeout(()=>{
            const btn = document.getElementById('save-'+idx);
            if(!btn) return;
            btn.onclick = null;
            btn.addEventListener('click', ()=>{
              data.spiess = document.getElementById('spiess-'+idx).value;
              data.oeffnungszeiten = document.getElementById('oeff-'+idx).value;
              data.addr = document.getElementById('addr-'+idx).value;
              data.tel = document.getElementById('tel-'+idx).value;
              marker.setPopupContent(popupHtml());
              marker.openPopup();
            },{once:true});
          },50);
        });

        markers.push(marker);
      });
    }).catch(err=>showError(err.message||err));

  }catch(e){showError(e.message||e);}
})();
</script>
</body>
</html>
