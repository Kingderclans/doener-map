<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Berlin Döner Map – Interaktiv</title>
  <style>
    #map { height: 100vh; width: 100%; margin: 0; padding: 0; }
    body { margin: 0; padding: 0; }
    input, select, button { margin-bottom: 4px; width: 100%; }
  </style>
  <!-- Leaflet‑Stylesheet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <!-- Kartencontainer -->
  <div id="map"></div>

  <!-- Leaflet‑Script -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    /**
     * Dieses Frontend lädt eine Liste von Dönerläden aus dem lokalen Speicher
     * (localStorage) oder aus der Datei `doener.json` und zeigt sie als farbige
     * Marker auf der Karte an. Durch Klick auf einen Marker öffnet sich ein
     * Popup, das die gespeicherten Daten anzeigt und die Bearbeitung ermöglicht.
     * Änderungen werden im localStorage gespeichert, sodass sie beim nächsten
     * Laden wieder vorhanden sind. Eine Anbindung an ein Backend kann leicht
     * ergänzt werden (siehe README.md).
     */

    let doenerLaeden = [];

    // Karte mit Zentrum Berlin initialisieren
    const map = L.map('map').setView([52.52, 13.405], 12);

    // OSM‑Tile‑Layer hinzufügen
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Farbe nach Spieß‑Status bestimmen
    const getColor = spieß => spieß === 'Spieß da' ? 'green' :
                               spieß === 'Spieß aus' ? 'red' : 'gray';

    /**
     * Für jeden Laden einen Marker erstellen. Der Marker ist ein Kreis mit
     * Farbcodierung je nach Spieß‑Status. Das Popup enthält sowohl die
     * aktuelle Anzeige als auch Eingabefelder zur Bearbeitung. Änderungen
     * aktualisieren den Marker, die Daten und speichern sie in localStorage.
     */
    function createMarker(laden, index) {
      const marker = L.circleMarker([laden.lat, laden.lng], {
        color: getColor(laden.spieß || laden.status),
        radius: 8
      }).addTo(map);

      // Popup‑Inhalt als Template‑String
      marker.bindPopup(`
        <b>Name:</b> <span id="name-${index}">${laden.name}</span><br>
        <b>Spieß:</b> <span id="spieß-${index}">${laden.spieß || laden.status}</span><br>
        <b>Öffnungszeiten:</b> <span id="hours-${index}">${laden.hours || ''}</span><br>
        <b>Adresse:</b> <span id="address-${index}">${laden.address || ''}</span><br>
        <b>Telefon:</b> <span id="phone-${index}">${laden.phone || ''}</span><br>
        <b>Alternativen / Menü:</b> <span id="menu-${index}">${laden.menu || ''}</span><br>
        <b>Datei:</b> <span id="file-${index}">${laden.fileName || ''}</span><br><br>

        <input id="input-name-${index}" value="${laden.name}" placeholder="Name">
        <select id="select-spieß-${index}">
          <option value="Spieß da" ${laden.spieß === 'Spieß da' || laden.status === 'Spieß da' ? 'selected' : ''}>Spieß da</option>
          <option value="Spieß aus" ${laden.spieß === 'Spieß aus' || laden.status === 'Spieß aus' ? 'selected' : ''}>Spieß aus</option>
          <option value="geschlossen" ${laden.spieß === 'geschlossen' || laden.status === 'geschlossen' ? 'selected' : ''}>geschlossen</option>
        </select>
        <input id="input-hours-${index}" value="${laden.hours || ''}" placeholder="Öffnungszeiten">
        <input id="input-address-${index}" value="${laden.address || ''}" placeholder="Adresse">
        <input id="input-phone-${index}" value="${laden.phone || ''}" placeholder="Telefon">
        <input id="input-menu-${index}" value="${laden.menu || ''}" placeholder="Alternativen / Menü">
        <input type="file" id="file-upload-${index}">
        <button id="btn-${index}">Ändern</button>
      `);

      // Beim Öffnen des Popups Event‑Handler registrieren
      marker.on('popupopen', () => {
        const btn = document.getElementById(`btn-${index}`);
        const select = document.getElementById(`select-spieß-${index}`);
        const inputName = document.getElementById(`input-name-${index}`);
        const inputHours = document.getElementById(`input-hours-${index}`);
        const inputAddress = document.getElementById(`input-address-${index}`);
        const inputPhone = document.getElementById(`input-phone-${index}`);
        const inputMenu = document.getElementById(`input-menu-${index}`);
        const fileUpload = document.getElementById(`file-upload-${index}`);

        btn.addEventListener('click', () => {
          const newSpieß = select.value;
          doenerLaeden[index].spieß = newSpieß;
          doenerLaeden[index].name = inputName.value;
          doenerLaeden[index].hours = inputHours.value;
          doenerLaeden[index].address = inputAddress.value;
          doenerLaeden[index].phone = inputPhone.value;
          doenerLaeden[index].menu = inputMenu.value;

          // Wenn eine Datei hochgeladen wurde, nur den Dateinamen speichern
          if (fileUpload.files.length > 0) {
            doenerLaeden[index].fileName = fileUpload.files[0].name;
          }

          // Markerfarbe aktualisieren
          marker.setStyle({ color: getColor(newSpieß) });

          // Felder im Popup aktualisieren
          document.getElementById(`name-${index}`).innerText = inputName.value;
          document.getElementById(`spieß-${index}`).innerText = newSpieß;
          document.getElementById(`hours-${index}`).innerText = inputHours.value;
          document.getElementById(`address-${index}`).innerText = inputAddress.value;
          document.getElementById(`phone-${index}`).innerText = inputPhone.value;
          document.getElementById(`menu-${index}`).innerText = inputMenu.value;
          document.getElementById(`file-${index}`).innerText = doenerLaeden[index].fileName || '';

          // Persistieren im localStorage
          localStorage.setItem('doenerLaeden', JSON.stringify(doenerLaeden));
        });
      });
    }

    // Daten laden: zuerst aus localStorage, dann Fallback auf doener.json
    const storedData = localStorage.getItem('doenerLaeden');
    if (storedData) {
      try {
        doenerLaeden = JSON.parse(storedData);
        doenerLaeden.forEach((laden, index) => createMarker(laden, index));
      } catch (err) {
        console.log('Fehler beim Laden der gespeicherten Daten:', err);
      }
    } else {
      // Fallback: Daten aus der Datei doener.json abrufen
      fetch('doener.json')
        .then(response => response.json())
        .then(data => {
          doenerLaeden = data;
          doenerLaeden.forEach((laden, index) => createMarker(laden, index));
        })
        .catch(err => console.log('Fehler beim Laden von doener.json:', err));
    }

    // Hinweis: Die Möglichkeit, durch Klick auf die Karte neue Marker hinzuzufügen,
    // wurde bewusst entfernt, um unkontrolliertes Hinzufügen zu verhindern.
  </script>
</body>
</html>